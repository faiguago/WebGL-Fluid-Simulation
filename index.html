<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="Cache-Control" content="no-cache">

        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="mobile-web-app-capable" content="yes">

        <link rel="apple-touch-icon" href="logo.png">
        <link rel="icon" href="logo.png">

        <title>WebGL Fluid Simulation</title>
        <meta name="description" content="A WebGL fluid simulation that works in mobile browsers.">

        <meta property="og:type" content="website">
        <meta property="og:title" content="Webgl Fluid Simulation">
        <meta property="og:description" content="A WebGL fluid simulation that works in mobile browsers.">
        <meta property="og:url" content="https://paveldogreat.github.io/WebGL-Fluid-Simulation/">
        <meta property="og:image" content="https://paveldogreat.github.io/WebGL-Fluid-Simulation/logo.png">

        <script type="text/javascript" src="dat.gui.min.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
        <script>eruda.init();</script>

        <script type="module">
            import { 
                MiniKit, 
                VerificationLevel,
                Tokens,
                tokenToDecimals
            } from "https://cdn.jsdelivr.net/npm/@worldcoin/minikit-js@1.9.8/+esm";

            const VERCEL_API_BASE = "https://juego02.vercel.app"; 

            MiniKit.install({});

            window.callConnectWallet = async () => {
                try {
                    const res = await fetch(VERCEL_API_BASE + "/api/nonce"); 
                    if(!res.ok) {
                       const errorBody = await res.text();
                       console.error("Error al obtener nonce:", res.status, errorBody);
                       throw new Error("No se pudo obtener el nonce. Respuesta cruda: " + errorBody);
                    }

                    const { nonce } = await res.json();

                    const { finalPayload } = await MiniKit.commandsAsync.walletAuth({
                        nonce,
                        expirationTime: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
                        notBefore: new Date(Date.now() - 24 * 60 * 60 * 1000)
                    });

                    if (finalPayload.status === 'success') {
                        // Autenticación exitosa: la promesa se resuelve.
                        return finalPayload;
                    } else {
                        // Autenticación fallida/cancelada: Lanzar un error para que la Promesa se rechace.
                        throw new Error("Autenticación con el monedero fallida o cancelada por el usuario.");
                    }

                } catch (err) {
                    console.error("Error callConnectWallet:", err);
                    // Re-lanzar el error para que el 'catch' en script.js lo intercepte.
                    throw err;
                }
            };

            window.callHandlePayment = async (amountWLDStr) => {
                const amountWLD = parseFloat(amountWLDStr);
                if (isNaN(amountWLD) || amountWLD <= 0) {
                    console.error("Monto inválido para el pago.", err);
                    return;
                }

                try {
                    const initRes = await fetch(VERCEL_API_BASE + "/api/initiate-payment", { 
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ amountWLD: amountWLD })
                    }); 
                    if (!initRes.ok) throw new Error("No se pudo iniciar el pago en el backend.");
                    const { id } = await initRes.json();
                    
                    const infoRes = await fetch(VERCEL_API_BASE + "/api/payment-info"); 

                    if (!infoRes.ok) throw new Error("No se pudo obtener la información de pago.");
                    
                    const { destinationAddress } = await infoRes.json(); 
                    
                    const amountDecimals = tokenToDecimals(amountWLD, Tokens.WLD);

                    const { finalPayload } = await MiniKit.commandsAsync.pay({
                        reference: id, 
                        to: destinationAddress, 
                        description: `Pago de ${amountWLD} WLD para tu Mini App`,
                        tokens: [{ symbol: Tokens.WLD, token_amount: amountDecimals.toString() }],
                    });

                    if (finalPayload.status === 'success') {
                        // Manejar pago exitoso!
                    } else {
                        // Pago fallido!
                    }
                } catch (err) {
                    console.error("Error en callHandlePayment:", err);
                }
            };
        </script>

        <style>
            @font-face {
                font-family: 'iconfont';
                src: url('iconfont.ttf') format('truetype');
            }

            * {
                user-select: none;
            }

            html, body {
                overflow: hidden;
                background-color: #000;
            }

            body {
                margin: 0;
                position: fixed;
                width: 100%;
                height: 100%;
            }

            canvas {
                width: 100%;
                height: 100%;
            }

            .dg {
                opacity: 0.9;
            }

            .dg .property-name {
                overflow: visible;
            }
        </style>
        <script>
            window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
            ga('create', 'UA-105392568-1', 'auto');
            ga('send', 'pageview');
        </script>
        <script async src="https://www.google-analytics.com/analytics.js"></script>
    </head>
    <body>
        <canvas></canvas>

        <script src="./script.js"></script>
    </body>
</html>